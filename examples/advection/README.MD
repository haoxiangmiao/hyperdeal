# Application: advection

The `advection` application performs a scalar transport <img src="https://render.githubusercontent.com/render/math?math=\partial f / \partial t  %2B  \nabla \cdot (\vec{a} f) = 0"> in high dimensions on an arbitrary phase-space domain <img src="https://render.githubusercontent.com/render/math?math=\Omega=\Omega_x \otimes \Omega_v"> for given boundary conditions<img src="https://render.githubusercontent.com/render/math?math=g|_\Gamma"> and a space- and time-independent velocity field <img src="https://render.githubusercontent.com/render/math?math=v">.

**NOTE:** For more detail, we refer readers to Sections 1-5 in [Munch, Kormann, and Kronbichler 2020](../../../../wiki/Publications).

Mesh, boundary conditions, initial condition, and velocity field can be provided by the user and are called **cases**. For a list of cases, see the folder [cases](cases). 

## Running the application

The application can be run as follows:
```bash
./advection A.json
```
where `A.json` a parameter file is that configures the solver and the case.

The application can be run in parallel with 40 MPI processes via:
```bash
mpirun -np 40 ./advection A.json
```

To run the application with multiple parameter files, one can provide a list of input parameter files:
```bash
mpirun -np 40 ./advection A.json B.json ...
```
In this case, the parameter files are processed one after the other and a convergence table is printed out at the end, making this configuration suitable for parameter (and in particular for performance) studies. Alternatively to the last command, one can also write: 
```bash
array=($(ls folder/*.json)); mpirun -np 40 ./operators "${array[@]}"
```
to run the application for all files matching the regex `folder/*.json` (i.e., all files in the folder `folder` with the suffix `.json`).

## Parameter input files

A parameter file is structured as follows. The `General`-section specifies the general setup of the simulation, i.a., regarding parallelization and the case to be run:

```json
{ 
    "General" : {
        "DimX"               : 2,
        "DimV"               : 2,
        "DegreeX"            : 3,
        "DegreeV"            : 3,
        "PartitionV"         : 1,
        "PartitionX"         : 1,
        "UseVirtualTopology" : true,
        "Verbose"            : true,
        "Case"               : "hyperrectangle"
    },
```
The `Case` section contains case-specific parameters, which differ from case to case:
```json
    "Case" : {
        "NRefinementsX"      : 2,
        "NRefinementsV"      : 2,
        "PeriodicX"          : true,
        "PeriodicV"          : true,
        "NSubdivisionsX"     : {"X" : 1, "Y" : 1, "Z" : 1},
        "NSubdivisionsV"     : {"X" : 1, "Y" : 1, "Z" : 1}
    },
```
The `Triangulation` section contains information regarding the mesh to be used:
```json
    "Triangulation" : {
        "Type"               : "fullydistributed",
        "OutputGrid"         : false
    },
```
By default, `dealii::parallal::fullydistributed::Triangulation` is used, which is parallel and does not depend on any third-party libraries. However, if the user has compiled `deal.II` with the library `p4est`, also the `dealii::parallel::distributed::Triangulation` can be chosen by specifying `distributed`.

The `SpatialDiscretization` section contains information regarding the spatial discretization:
```json
    "SpatialDiscretization" : {
        "DoCollocation"      : false,
        "MappingX"           : 1,
        "MappingV"           : 1
    },
```

The `TemporalDiscretization` section contains information regarding the temporal discretization, post-processing, and performance counters:
```json
    "TemporalDiscretization" : {
        "StartTime"          : 0.0,
        "FinalTime"          : 20.0,
        "TimeStep"           : 0.1,
        "MaxTimeStepNumber"  : 100000000,
        "CFLNumber"          : 0.3,
        "OutputTick"         : 0.2
    },
```
The `Matrixfree` section contains information regarding the matrix-free operator evaluation:
```json
    "Matrixfree" : {
        "DoBuffering"        : false,
        "GhostFaces"         : true,
        "UseECL"             : true
    }
}
```

**NOTE:** The parameter files might change over time, since new parameters might be added so that the parameter file shown above might be outdated. To view the up-to-date parameters for the case `hyperrectangle`, one can write:
```bash
./advection --help hyperrectangle
```
To generate a dummy input parameter file, one can simply pipe the output of this command into a new file and run this file:
```bash
./advection --help hyperrectangle > hyperrectangle.json
./advection hyperrectangle.json
```

A detailed documentation of each parameter can be automatically generated by:
```bash
./advection --help-detail hyperrectangle
```


## Creating a new case

A new case can be created by implementing the following abstract class:
```cpp
namespace advection {
  namespace hyperdeal {
  
    template <int dim_x, int dim_v, int degree, typename Number>
    class Initializer
    {
    public:
      virtual void
      add_parameters(dealii::ParameterHandler &prm)
      {
        // register case-specific parameters
      }

      virtual void
      create_grid(std::shared_ptr<dealii::parallel::TriangulationBase<dim_x>> &triangulation_x,
                  std::shared_ptr<dealii::parallel::TriangulationBase<dim_v>> &triangulation_v)
      {
        // create x- and v-space triangulation
      }


      virtual void
      set_boundary_conditions(
        std::shared_ptr< hyperdeal::advection::BoundaryDescriptor<dim_x + dim_v, Number>> bc)
      {
        // create boundary conditions
      }

      virtual void
      set_analytical_solution(
        std::shared_ptr<dealii::Function<dim_x + dim_v, Number>> &analytical_solution)
      {
        // set analytical solution (used as initial condition and to compute errors) 
      }

      virtual dealii::Tensor<1, dim_x + dim_v>
      get_transport_direction()
      {
        // return the direction and magnitude of the constant velocity field
      }
    };
  } // namespace advection
} // namespace hyperdeal
```
